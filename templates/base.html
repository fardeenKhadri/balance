<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Hakogane - Expense Tracker</title>
    <link
      rel="icon"
      type="image/png"
      href="{{ url_for('static', filename='images/favicon.png') }}"
    />
    <link
      rel="stylesheet"
      href="{{ url_for('static', filename='css/style.css') }}"
    />
    <link
      href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;600&display=swap"
      rel="stylesheet"
    />
  </head>

  <body class="{% block body_class %}{% endblock %}">
    <div class="background-blobs">
      <div class="blob blob-1"></div>
      <div class="blob blob-2"></div>
      <div class="blob blob-3"></div>
    </div>

    <nav>
      <div class="nav-container">
        <a href="{{ url_for('index') }}" class="logo">Hakogane</a>
        {% if current_user.is_authenticated %}
        <div class="nav-links">
          <span>Welcome, {{ current_user.username }}</span>
          <button id="profileBtn" class="profile-btn" title="Update Profile">
            <svg viewBox="0 0 24 24">
              <path
                d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"
              />
            </svg>
          </button>
          <a href="{{ url_for('logout') }}" class="btn-secondary">Logout</a>
        </div>
        {% endif %}
      </div>
    </nav>

    <!-- Profile Modal -->
    {% if current_user.is_authenticated %}
    <div id="profileModal" class="modal">
      <div class="modal-content">
        <div class="modal-header">
          <h2>Operator Profile</h2>
          <span class="close-modal">&times;</span>
        </div>
        <div class="modal-body">
          <form action="{{ url_for('update_profile') }}" method="POST">
            <div class="form-group">
              <label>Monthly Credit Day</label>
              <input
                type="number"
                name="billing_cycle"
                min="1"
                max="31"
                value="{{ current_user.salary_credit_day }}"
                required
              />
            </div>
            <button type="submit" class="btn-primary">Update Protocol</button>
          </form>

          <div
            class="form-group"
            style="
              margin-top: 2.5rem;
              border-top: 1px solid var(--glass-border);
              padding-top: 2rem;
            "
          >
            <label>Historical Operational Logs</label>
            <div style="display: flex; gap: 1rem; margin-top: 1rem">
              <select
                id="statementSelect"
                style="
                  flex: 1;
                  padding: 0.8rem;
                  background: rgba(0, 0, 0, 0.4);
                  border: 1px solid var(--glass-border);
                  color: white;
                  border-radius: 4px;
                  font-family: inherit;
                "
              >
                <option value="">Select Cycle...</option>
                {% for b in available_budgets %}
                <option
                  value="{{ b.month_start_date.year }}-{{ b.month_start_date.month }}"
                >
                  {{ b.month_start_date.strftime('%B %Y') }}
                </option>
                {% endfor %}
              </select>
              <button
                type="button"
                id="downloadPastBtn"
                class="btn-secondary"
                style="padding: 0.8rem 1.2rem"
              >
                Fetch
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>
    {% endif %}

    <main>
      {% with messages = get_flashed_messages() %} {% if messages %}
      <div class="flash-messages">
        {% for message in messages %}
        <div class="flash">{{ message }}</div>
        {% endfor %}
      </div>
      {% endif %} {% endwith %} {% block content %}{% endblock %}
    </main>

    <footer>
      <p>&copy; 2026 Balance App - Personal Account Manager</p>
    </footer>

    <script>
      const modal = document.getElementById("profileModal");
      const btn = document.getElementById("profileBtn");
      const span = document.getElementsByClassName("close-modal")[0];
      const downloadPastBtn = document.getElementById("downloadPastBtn");
      const statementSelect = document.getElementById("statementSelect");

      if (btn) {
        btn.onclick = function () {
          modal.style.display = "block";
        };
      }

      if (span) {
        span.onclick = function () {
          modal.style.display = "none";
        };
      }

      if (downloadPastBtn) {
        downloadPastBtn.onclick = function () {
          const val = statementSelect.value;
          if (val) {
            const [year, month] = val.split("-");
            window.location.href = `/download_statement?year=${year}&month=${month}`;
          } else {
            alert("Please select a cycle first.");
          }
        };
      }

      window.onclick = function (event) {
        if (event.target == modal) {
          modal.style.display = "none";
        }
      };
    </script>
  </body>
</html>
